<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Projection Comparison - Nupabomba</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .map-container {
            margin-bottom: 30px;
        }
        h2 {
            margin-bottom: 10px;
        }
        .map {
            height: 400px;
            border: 2px solid #333;
        }
    </style>
</head>
<body>
    <h1>Map Projection Comparison - Nupabomba</h1>
    
    <div class="map-container">
        <h2>1. Web Mercator (EPSG:3857) - Default</h2>
        <div id="map1" class="map"></div>
    </div>

    <div class="map-container">
        <h2>2. WGS84 / Plate Carrée (EPSG:4326)</h2>
        <div id="map2" class="map"></div>
    </div>

    <script>
        // Single main map with two base layers and overlays
        var center = [-0.7296383, 119.9170921];
        var map = L.map('map1').setView(center, 16);

        // Base layers
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        });

        var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: '© Google',
            subdomains:['mt0','mt1','mt2','mt3']
        });

        // Add default base
        osm.addTo(map);

        // Overlay groups
        var markersLayer = L.layerGroup();
        var linesLayer = L.layerGroup();
        var polygonsLayer = L.layerGroup();

        // Layer control
        var baseMaps = {
            "OpenStreetMap": osm,
            "Satellite": satellite
        };

        var overlayMaps = {
            "Markers": markersLayer,
            "Polylines": linesLayer,
            "Polygons": polygonsLayer
        };

        L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

        // Also add a scale and zoom control
        L.control.scale().addTo(map);

        // Helper functions for styling
        function styleLine(feature){
            return { color: '#ff7800', weight: 4 };
        }
        function stylePolygon(feature){
            return { color: '#3388ff', weight: 2, fillColor: '#3388ff', fillOpacity: 0.2 };
        }

        // Load GeoJSON and split into overlay layers
        fetch('map.geojson')
            .then(res => res.json())
            .then(data => {
                data.features.forEach(function(feature){
                    var geomType = feature.geometry && feature.geometry.type;
                    var props = feature.properties || {};
                    var popupText = props.name || JSON.stringify(props);

                    if(geomType === 'Point'){
                        var coords = feature.geometry.coordinates;
                        // Leaflet uses [lat, lng]
                        var marker = L.marker([coords[1], coords[0]]).bindPopup(popupText);
                        markersLayer.addLayer(marker);
                    } else if(geomType === 'LineString'){
                        var latlngs = feature.geometry.coordinates.map(function(c){ return [c[1], c[0]]; });
                        var polyline = L.polyline(latlngs, styleLine(feature)).bindPopup(popupText);
                        linesLayer.addLayer(polyline);
                    } else if(geomType === 'Polygon'){
                        var latlngs = feature.geometry.coordinates.map(function(ring){ return ring.map(function(c){ return [c[1], c[0]]; }); });
                        var polygon = L.polygon(latlngs, stylePolygon(feature)).bindPopup(popupText);
                        polygonsLayer.addLayer(polygon);
                    } else {
                        // fallback: add via geoJSON for any other type
                        L.geoJSON(feature, {
                            onEachFeature: function(f, layer){ layer.bindPopup(popupText); }
                        }).addTo(map);
                    }
                });

                // Add overlays to map by default
                markersLayer.addTo(map);
                linesLayer.addTo(map);
                polygonsLayer.addTo(map);

                // Fit map to all features if any
                var all = L.featureGroup([markersLayer, linesLayer, polygonsLayer]);
                if(all.getLayers().length > 0){
                    map.fitBounds(all.getBounds(), { padding: [20,20] });
                }
            })
            .catch(err => console.log('Could not load map.geojson:', err));

        // Secondary map (EPSG:4326) kept as a comparison view in the second container
        var map2 = L.map('map2', {crs: L.CRS.EPSG4326}).setView(center, 13);
        L.tileLayer.wms('https://ows.terrestris.de/osm/service?', {
            layers: 'OSM-WMS',
            format: 'image/png',
            transparent: false,
            attribution: '© terrestris, OpenStreetMap contributors'
        }).addTo(map2);

        // Also add GeoJSON to map2 using simple geoJSON layer so popups still work there
        fetch('map.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    onEachFeature: function(feature, layer){
                        layer.bindPopup(feature.properties && feature.properties.name);
                    }
                }).addTo(map2);
            });
    </script>
</body>
</html>